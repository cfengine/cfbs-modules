promise agent iptables
{
    path => "$(sys.workdir)/modules/promises/iptables.py";
    interpreter => "/usr/bin/python3";
}

body common control
{
    bundlesequence => {
       cfengine_com_accepted,
       telnet_dropped,
       accept_ssh_high_priority,
       cfengine_com_deleted,
       aggressive_policy,
       input_flushed,
       all_flushed,
       rule_exclusivity,
    };
}

bundle agent cfengine_com_accepted
{
  iptables:
      "accept_cfengine_com"
        command => "append",
        chain => "INPUT",
        source => "34.107.174.45",
        target => "ACCEPT";

  reports:
      "--- ${this.bundle} ---";
}

bundle agent telnet_dropped
{
  iptables:
      "accept_cfengine_com"
        command => "append",
        chain => "INPUT",
        protocol => "tcp",
        destination_port => "23",
        target => "DROP";

  reports:
      "--- ${this.bundle} ---";
}

bundle agent accept_ssh_high_priority
{
  iptables:
      "accept_ssh"
        command => "insert",
        chain => "INPUT",
        protocol => "tcp",
        destination_port => "1",
        priority => "4",
        target => "ACCEPT";

  reports:
      "--- ${this.bundle} ---";
}

bundle agent cfengine_com_deleted
{
  iptables:
      "delete_accept_cfengine_com"
        command => "delete",
        chain => "INPUT",
        source => "34.107.174.45",
        priority => "-1",
        target => "ACCEPT";

  reports:
      "--- ${this.bundle} ---";
}

bundle agent aggressive_policy
{
  iptables:
      "aggressive_policy"
        command => "policy",
        chain => "INPUT",
        target => "DROP";

  reports:
      "--- ${this.bundle} ---";
}

bundle agent input_flushed
{
  iptables:
      "input_flushed"
        command => "flush",
        chain => "INPUT";

  reports:
      "--- ${this.bundle} ---";
}

bundle agent all_flushed
{
  iptables:
      "all_flushed"
        command => "flush",
        chain => "ALL";

  reports:
      "--- ${this.bundle} ---";
}

bundle common allow_cfengine_and_ssh
{
  vars:
    "rules" data => '{
        "table": "filter",
        "chain": "INPUT",
        "rule_specs": {
          "accept_cfengine": {
            "source": "34.107.174.45",
            "priority": -1,
            "target": "ACCEPT"
          },
          "accept_ssh": {
            "protocol": "tcp",
            "destination_port": 22,
            "priority": 4,
            "target": "ACCEPT"
          },
        }
    }';
}

bundle agent rule_exclusivity
{
  iptables:
      "clean_non_cfengine_rules"
        command => "exclusive",
        chain => "${allow_cfengine_and_ssh.rules[chain]}",
        rules => @{allow_cfengine_and_ssh.rules};

  reports:
      "--- ${this.bundle} ---";
}

